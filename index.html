<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Cat√°logo de Tapes</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-slate-100 text-slate-800 dark:bg-slate-900 dark:text-white font-sans">

<div class="max-w-7xl mx-auto pb-24 p-4 md:p-6">

    <!-- Cabe√ßalho -->
    <div class="mb-6">
        <h1 class="text-2xl md:text-3xl font-bold">Ol√°, Ulisses üëã</h1>
        <p class="text-slate-500 dark:text-slate-400 text-sm">
            Bem-vindo ao seu cat√°logo de tapes
        </p>
    </div>

    <!-- Cards Estat√≠sticas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">

        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow">
            <div class="text-xs uppercase text-slate-500">Total Tapes</div>
            <div class="text-2xl font-bold" id="stat-tapes">0</div>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow">
            <div class="text-xs uppercase text-slate-500">Artistas</div>
            <div class="text-2xl font-bold" id="stat-artistas">0</div>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow">
            <div class="text-xs uppercase text-slate-500">Gravadoras</div>
            <div class="text-2xl font-bold" id="stat-gravadoras">0</div>
        </div>

        <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow">
            <div class="text-xs uppercase text-slate-500">Faixas</div>
            <div class="text-2xl font-bold" id="stat-faixas">0</div>
        </div>

    </div>

    <!-- √öltimos 5 Tapes -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow mb-6">
        <h2 class="font-semibold text-lg mb-4">
            <i class="fas fa-clock mr-2 text-indigo-500"></i>
            √öltimos 5 Tapes
        </h2>

        <div id="previewTapes" class="space-y-3">
            <div class="text-slate-500 text-center py-4">Carregando...</div>
        </div>
    </div>

    <!-- Top 5 Artistas -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 shadow">
        <h2 class="font-semibold text-lg mb-4">
            <i class="fas fa-star mr-2 text-indigo-500"></i>
            Top 5 Artistas
        </h2>

        <div id="topArtistas" class="space-y-3">
            <div class="text-slate-500 text-center py-4">Carregando...</div>
        </div>
    </div>

</div>

<!-- Bottom Navigation estilo APK -->
<nav class="fixed bottom-0 left-0 w-full bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 shadow-lg">
    <div class="grid grid-cols-5 text-center text-xs">

        <a href="index.html" class="py-3 flex flex-col items-center text-indigo-600">
            <i class="fas fa-home text-lg"></i>
            <span>Home</span>
        </a>

        <a href="tapes.html" class="py-3 flex flex-col items-center hover:text-indigo-600">
            <i class="fas fa-cassette text-lg"></i>
            <span>Tapes</span>
        </a>

        <a href="musicas.html" class="py-3 flex flex-col items-center hover:text-indigo-600">
            <i class="fas fa-music text-lg"></i>
            <span>M√∫sicas</span>
        </a>

        <a href="artistas.html" class="py-3 flex flex-col items-center hover:text-indigo-600">
            <i class="fas fa-microphone text-lg"></i>
            <span>Artistas</span>
        </a>

        <a href="gravadoras.html" class="py-3 flex flex-col items-center hover:text-indigo-600">
            <i class="fas fa-building text-lg"></i>
            <span>Labels</span>
        </a>

    </div>
</nav>

<script>
    const SUPABASE_URL = 'https://edabpftowxcyvsmuzzdf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_xUUhpgcgM7bc2Q5a02smMw_n5xDicbW';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Estat√≠sticas
    async function carregarEstatisticas() {
        try {
            const [tapesRes, artistasRes, gravadorasRes, faixasRes] = await Promise.all([
                supabaseClient.from('tapes').select('*', { count: 'exact', head: true }),
                supabaseClient.from('artistas').select('*', { count: 'exact', head: true }),
                supabaseClient.from('gravadoras').select('*', { count: 'exact', head: true }),
                supabaseClient.from('faixas').select('*', { count: 'exact', head: true })
            ]);

            document.getElementById('stat-tapes').textContent = tapesRes.count || 0;
            document.getElementById('stat-artistas').textContent = artistasRes.count || 0;
            document.getElementById('stat-gravadoras').textContent = gravadorasRes.count || 0;
            document.getElementById('stat-faixas').textContent = faixasRes.count || 0;

        } catch (err) {
            console.error('Erro ao carregar estat√≠sticas:', err);
        }
    }

    // √öltimos 5 tapes
    async function carregarUltimosTapes() {
        try {
            const { data, error } = await supabaseClient
                .from('tapes')
                .select(`
                    id,
                    titulo,
                    numero_tape,
                    artistas ( nome ),
                    gravadoras ( nome )
                `)
                .order('id', { ascending: false })
                .limit(5);

            if (error) throw error;

            const container = document.getElementById('previewTapes');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-center py-4">Nenhum tape encontrado.</div>';
                return;
            }

            container.innerHTML = data.map(tape => `
                <div class="flex items-center justify-between border-b border-slate-200 dark:border-slate-700 pb-2 last:border-0">
                    <div>
                        <div class="font-medium">${tape.titulo || 'Sem t√≠tulo'}</div>
                        <div class="text-xs text-slate-500">
                            ${tape.artistas?.nome || 'Artista desconhecido'}
                            ${tape.gravadoras?.nome ? ' ‚Ä¢ ' + tape.gravadoras.nome : ''}
                        </div>
                    </div>
                    <a href="ver.html?id=${tape.id}" class="text-indigo-500 text-sm hover:underline">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            `).join('');

        } catch (err) {
            console.error(err);
        }
    }

    // Top 5 artistas
    async function carregarTopArtistas() {
        try {
            const { data, error } = await supabaseClient
                .from('tapes')
                .select('artista_id, artistas ( nome )')
                .not('artista_id', 'is', null);

            if (error) throw error;

            const contagem = {};

            data.forEach(item => {
                const id = item.artista_id;
                const nome = item.artistas?.nome || 'Desconhecido';

                if (!contagem[id]) {
                    contagem[id] = { nome, count: 0 };
                }

                contagem[id].count++;
            });

            const ranking = Object.values(contagem)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            const container = document.getElementById('topArtistas');

            if (ranking.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-center py-4">Nenhum artista com tapes.</div>';
                return;
            }

            container.innerHTML = ranking.map((item, idx) => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="text-slate-400 text-sm">${idx + 1}.</span>
                        <span class="font-medium">${item.nome}</span>
                    </div>
                    <span class="bg-indigo-500/20 text-indigo-600 dark:text-indigo-300 text-xs px-2 py-1 rounded-full">
                        ${item.count} tapes
                    </span>
                </div>
            `).join('');

        } catch (err) {
            console.error(err);
        }
    }

    (async () => {
        await carregarEstatisticas();
        await carregarUltimosTapes();
        await carregarTopArtistas();
    })();
</script>

</body>
</html>
