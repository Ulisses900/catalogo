{% extends "base.html" %}

{% block title %}Catálogo - Músicas{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="min-h-screen bg-slate-50/50 p-4 md:p-8">
  <div class="max-w-7xl mx-auto">

    <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <nav class="flex items-center text-xs font-bold text-slate-400 mb-2 uppercase tracking-widest">
          <a href="{{ url_for('catalogo.index') }}" class="hover:text-indigo-600 transition">Dashboard</a>
          <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
          <span class="text-indigo-600">Músicas</span>
        </nav>
        <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Músicas do Banco</h1>
        <p class="text-slate-500 text-sm mt-1">Gerencie as faixas e fonogramas cadastrados no sistema.</p>
      </div>

      <div class="flex items-center gap-3">
        <button onclick="exportarTudo()" class="inline-flex items-center px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 hover:bg-slate-50 shadow-sm transition-all active:scale-95">
          <i class="fas fa-file-export mr-2 text-indigo-500"></i> Exportar CSV
        </button>
        <a href="#" class="inline-flex items-center px-4 py-2.5 bg-indigo-600 rounded-xl text-sm font-bold text-white hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95">
          <i class="fas fa-plus mr-2"></i> Nova Música
        </a>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 mb-6">
      <div class="flex flex-wrap items-center gap-4">
        <div class="flex-1 min-w-[260px] relative group">
          <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 group-focus-within:text-indigo-500 transition-colors">
            <i class="fas fa-search"></i>
          </span>
          <input type="text" id="search-input" placeholder="Buscar por título, artista ou tape..."
                 class="block w-full pl-11 pr-4 py-3 bg-slate-50 border-transparent rounded-xl focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm transition-all">
        </div>

        <div class="w-full md:w-56">
          <select id="filter-field"
                  class="block w-full px-4 py-3 bg-slate-50 border-transparent rounded-xl text-sm font-bold text-slate-600 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all">
            <option value="todos">Todos os campos</option>
            <option value="musica">Título da Música</option>
            <option value="artista">Artista</option>
            <option value="tape">Nome/Nº da Tape</option>
            <option value="lado">Lado (A/B)</option>
            <option value="isrc">ISRC</option>
          </select>
        </div>

        <div class="w-full md:w-44">
          <select id="limit-select"
                  class="block w-full px-4 py-3 bg-slate-50 border-transparent rounded-xl text-sm font-bold text-slate-600 focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all">
            <option value="10">10 por página</option>
            <option value="25" selected>25 por página</option>
            <option value="50">50 por página</option>
          </select>
        </div>

        <button id="search-button"
                class="px-8 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all text-sm font-bold shadow-lg shadow-indigo-100 flex items-center justify-center">
          <i class="fas fa-filter mr-2"></i> Filtrar
        </button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-100">
          <thead class="bg-slate-50/50">
            <tr>
              <th onclick="alternarOrdenacao('id')" class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-indigo-600 group transition-colors">
                ID <i class="fas fa-sort ml-1 opacity-30 group-hover:opacity-100"></i>
              </th>
              <th onclick="alternarOrdenacao('musica')" class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-indigo-600 group transition-colors">
                Música <i class="fas fa-sort ml-1 opacity-30 group-hover:opacity-100"></i>
              </th>
              <th onclick="alternarOrdenacao('artista')" class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-indigo-600 group transition-colors">
                Artista <i class="fas fa-sort ml-1 opacity-30 group-hover:opacity-100"></i>
              </th>
              <th onclick="alternarOrdenacao('tape')" class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-indigo-600 group transition-colors">
                Tape <i class="fas fa-sort ml-1 opacity-30 group-hover:opacity-100"></i>
              </th>
              <th onclick="alternarOrdenacao('lado')" class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest cursor-pointer hover:text-indigo-600 group transition-colors">
                Lado <i class="fas fa-sort ml-1 opacity-30 group-hover:opacity-100"></i>
              </th>
              <th class="px-6 py-4 text-right text-xs font-bold text-slate-500 uppercase tracking-widest">Ações</th>
            </tr>
          </thead>

          <tbody id="musicas-body" class="divide-y divide-slate-50">
            <tr>
              <td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium animate-pulse">Carregando músicas...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="px-6 py-5 bg-slate-50/30 border-t border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div class="text-sm text-slate-500">
          Mostrando <span id="current-items" class="font-bold text-slate-900">0</span> de <span id="total-items" class="font-bold text-slate-900">0</span> registros
        </div>

        <div class="flex items-center gap-2">
          <button id="prev-page" class="p-2 px-4 rounded-xl border border-slate-200 bg-white text-slate-600 font-bold hover:bg-slate-50 disabled:opacity-40 transition-all">
            <i class="fas fa-chevron-left mr-1"></i> Anterior
          </button>
          <div id="page-numbers" class="px-4 py-2 text-sm font-bold text-indigo-600 bg-indigo-50 rounded-xl border border-indigo-100">
            Página 1
          </div>
          <button id="next-page" class="p-2 px-4 rounded-xl border border-slate-200 bg-white text-slate-600 font-bold hover:bg-slate-50 disabled:opacity-40 transition-all">
            Próxima <i class="fas fa-chevron-right ml-1"></i>
          </button>
        </div>
      </div>
    </div>

    <div id="deleteModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-md border border-slate-100 overflow-hidden">
        <div class="p-5 border-b border-slate-100 flex items-center justify-between">
          <h3 class="text-sm font-extrabold uppercase tracking-widest text-slate-500">Confirmar exclusão</h3>
          <button onclick="closeDeleteModal()" class="text-slate-400 hover:text-slate-700"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-5">
          <p class="text-sm text-slate-600">Tem certeza que deseja excluir a música <span class="font-extrabold text-slate-900" id="deleteNome">—</span>?</p>
        </div>
        <div class="p-5 bg-slate-50/50 border-t border-slate-100 flex justify-end gap-2">
          <button onclick="closeDeleteModal()" class="px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-bold hover:bg-slate-50">Cancelar</button>
          <button id="confirmDeleteBtn" class="px-4 py-2 rounded-xl bg-rose-600 text-white font-extrabold hover:bg-rose-700">Excluir</button>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let totalPages = 1;
let limit = 25;
let currentSort = 'id';
let sortOrder = 'desc';
let deleteId = null;

// Endpoints (Certifique-se que estas rotas existem no seu catalogo.py)
const SEARCH_URL = "{{ url_for('catalogo.api_search_musicas') }}";
const VIEW_URL_TPL = "{{ url_for('catalogo.musicas_view', musica_id=0) }}";
const EDIT_URL_TPL = "{{ url_for('catalogo.musicas_edit', musica_id=0) }}";
const DELETE_URL_TPL = "{{ url_for('catalogo.api_delete_musica', musica_id=0) }}";

document.addEventListener('DOMContentLoaded', () => {
  const limitEl = document.getElementById('limit-select');
  limit = parseInt(limitEl.value, 10) || 25;

  carregarMusicas();

  document.getElementById('search-button').addEventListener('click', () => { currentPage = 1; carregarMusicas(); });
  document.getElementById('search-input').addEventListener('keyup', (e) => { if (e.key === 'Enter') { currentPage = 1; carregarMusicas(); } });
  
  limitEl.addEventListener('change', () => {
    limit = parseInt(limitEl.value, 10) || 25;
    currentPage = 1;
    carregarMusicas();
  });

  document.getElementById('prev-page').addEventListener('click', () => { if (currentPage > 1) { currentPage--; carregarMusicas(); } });
  document.getElementById('next-page').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; carregarMusicas(); } });
});

function alternarOrdenacao(coluna) {
  if (currentSort === coluna) {
    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort = coluna;
    sortOrder = 'asc';
  }
  currentPage = 1;
  carregarMusicas();
}

async function carregarMusicas() {
  const tbody = document.getElementById('musicas-body');
  const termo = document.getElementById('search-input').value || '';
  const campo = document.getElementById('filter-field').value || 'todos';

  tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400 font-medium animate-pulse">Carregando músicas...</td></tr>';

  try {
    const params = new URLSearchParams({ termo, campo, page: currentPage, limit, sort: currentSort, order: sortOrder });
    const resp = await fetch(`${SEARCH_URL}?${params.toString()}`);
    const data = await resp.json();

    const musicas = data.musicas || [];
    totalPages = data.total_paginas || 1;

    document.getElementById('current-items').textContent = musicas.length;
    document.getElementById('total-items').textContent = data.total_registros || 0;
    document.getElementById('page-numbers').textContent = `Página ${currentPage} de ${totalPages}`;
    document.getElementById('prev-page').disabled = currentPage <= 1;
    document.getElementById('next-page').disabled = currentPage >= totalPages;

    if (!musicas.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-400">Nenhuma música encontrada.</td></tr>';
      return;
    }

    tbody.innerHTML = musicas.map(m => {
      const viewUrl = VIEW_URL_TPL.replace('/0/', '/' + m.id + '/');
      const editUrl = EDIT_URL_TPL.replace('/0/', '/' + m.id + '/');
      const tapeTxt = m.tape ? (m.tape.titulo || m.tape.numero_tape || ('#' + m.tape.id)) : '—';

      return `
        <tr class="hover:bg-indigo-50/40 transition-colors group">
          <td class="px-6 py-4 text-xs font-mono text-slate-400">#${m.id}</td>
          <td class="px-6 py-4">
            <div class="text-sm font-extrabold text-slate-900 group-hover:text-indigo-600 transition-colors">
              ${m.musica || m.titulo || '—'}
            </div>
            <div class="text-xs text-slate-400">Autor: ${m.autor || '—'}</div>
          </td>
          <td class="px-6 py-4 text-sm text-slate-700 font-bold">${m.artista?.nome || m.artista || '—'}</td>
          <td class="px-6 py-4">
            <div class="text-sm text-slate-700 font-bold">${tapeTxt}</div>
          </td>
          <td class="px-6 py-4 text-sm text-slate-600 font-bold">${m.lado || '—'}</td>
          <td class="px-6 py-4 text-right">
            <div class="flex justify-end gap-2">
              <a href="${viewUrl}" class="p-2 text-slate-400 hover:text-blue-600 rounded-lg transition-all"><i class="fas fa-eye"></i></a>
              <a href="${editUrl}" class="p-2 text-slate-400 hover:text-indigo-600 rounded-lg transition-all"><i class="fas fa-edit"></i></a>
              <button onclick="openDeleteModal(${m.id}, '${(m.musica || m.titulo || '').replace(/'/g, "\\'")}')" class="p-2 text-slate-400 hover:text-rose-600 rounded-lg transition-all">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          </td>
        </tr>`;
    }).join('');

  } catch (err) {
    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-rose-500 font-bold">Erro ao carregar dados.</td></tr>';
  }
}

function openDeleteModal(id, nome) {
  deleteId = id;
  document.getElementById('deleteNome').textContent = nome;
  document.getElementById('deleteModal').classList.remove('hidden');
  document.getElementById('deleteModal').classList.add('flex');
  document.getElementById('confirmDeleteBtn').onclick = confirmarExclusao;
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
  document.getElementById('deleteModal').classList.remove('flex');
}

async function confirmarExclusao() {
  try {
    const url = DELETE_URL_TPL.replace('/0', '/' + deleteId);
    const resp = await fetch(url, { method: 'DELETE' });
    if (resp.ok) {
      closeDeleteModal();
      carregarMusicas();
    }
  } catch (err) {
    alert('Erro ao excluir música.');
  }
}

function exportarTudo() {
  window.open("{{ url_for('catalogo.api_export_musicas') }}", '_blank');
}
</script>
{% endblock %}