{% extends "base.html" %}

{% block title %}Artistas{% endblock %}
{% block header %}Artistas{% endblock %}

{% block content %}
<div class="p-6">
    <h1 class="text-3xl font-bold mb-6">Artistas</h1>

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-bold mb-4">Adicionar/Editar Artista</h2>
        <form id="form-artista" class="flex flex-col md:flex-row md:space-x-4">
            <input type="hidden" id="artista-id">
            <input type="text" id="nome-artista" placeholder="Nome do Artista" required class="flex-1 p-2 border border-gray-300 rounded-md">
            <input type="text" id="funcao-artista" placeholder="Função (Ex: Vocalista)" class="flex-1 p-2 border border-gray-300 rounded-md">
            <button type="submit" class="mt-4 md:mt-0 bg-blue-500 text-white px-4 py-2 rounded-md">Salvar</button>
            <button type="button" id="btn-cancelar" class="mt-2 md:mt-0 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hidden">Cancelar</button>
        </form>
    </div>
    
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-bold mb-4">Filtrar Artistas</h2>
        <form id="form-filtro" class="flex flex-col md:flex-row md:space-x-4">
            <input type="text" id="termo-busca" placeholder="Buscar por nome..." class="flex-1 p-2 border border-gray-300 rounded-md">
            <button type="submit" class="mt-4 md:mt-0 bg-blue-500 text-white px-4 py-2 rounded-md">Buscar</button>
            <button type="button" id="btn-limpar" class="mt-2 md:mt-0 bg-gray-300 text-gray-700 px-4 py-2 rounded-md">Limpar</button>
        </form>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4">Lista de Artistas</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Função</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody id="tabela-artistas" class="bg-white divide-y divide-gray-200">
                </tbody>
        </table>
    </div>
    
    <div id="paginacao" class="flex justify-between items-center mt-6">
        <div>
            <span id="info-paginacao" class="text-sm text-gray-700"></span>
        </div>
        <div class="flex space-x-2">
            <button id="btn-anterior" class="px-4 py-2 border rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Anterior</button>
            <button id="btn-proximo" class="px-4 py-2 border rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">Próximo</button>
        </div>
    </div>
</div>

<script>
let paginaAtual = 1;
let termoBusca = '';
let buscando = false;
let debounceTimer;

document.addEventListener('DOMContentLoaded', () => {
  carregarArtistas();

  document.getElementById('form-artista').addEventListener('submit', salvarArtista);
  document.getElementById('btn-cancelar').addEventListener('click', resetarFormulario);

  document.getElementById('form-filtro').addEventListener('submit', (e) => {
    e.preventDefault();
    termoBusca = document.getElementById('termo-busca').value.trim();
    paginaAtual = 1;
    carregarArtistas();
  });

  document.getElementById('termo-busca').addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      termoBusca = document.getElementById('termo-busca').value.trim();
      paginaAtual = 1;
      carregarArtistas();
    }, 350);
  });

  document.getElementById('btn-limpar').addEventListener('click', () => {
    document.getElementById('termo-busca').value = '';
    termoBusca = '';
    paginaAtual = 1;
    carregarArtistas();
  });

  document.getElementById('btn-anterior').addEventListener('click', () => {
    if (paginaAtual > 1) { paginaAtual--; carregarArtistas(); }
  });

  document.getElementById('btn-proximo').addEventListener('click', () => {
    paginaAtual++; carregarArtistas();
  });
});

async function carregarArtistas() {
  if (buscando) return;
  buscando = true;

  const tabelaBody = document.getElementById('tabela-artistas');
  const infoPaginacao = document.getElementById('info-paginacao');
  const btnAnterior = document.getElementById('btn-anterior');
  const btnProximo = document.getElementById('btn-proximo');

  tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Carregando...</td></tr>';

  try {
    const params = new URLSearchParams({
      page: paginaAtual,
      limit: 30,
      termo: termoBusca
    });
    const response = await fetch(`/api/artistas?${params}`);
    if (!response.ok) throw new Error('Falha ao carregar artistas');

    const data = await response.json();

    tabelaBody.innerHTML = '';
    if (!data.artistas || data.artistas.length === 0) {
      tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Nenhum artista encontrado.</td></tr>';
    } else {
      data.artistas.forEach(a => {
        const row = document.createElement('tr');
        const nomeSafe = (a.nome || '').replace(/'/g, "\\'");
        const funcaoSafe = (a.funcao || '').replace(/'/g, "\\'");
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">${a.id}</td>
          <td class="px-6 py-4 whitespace-nowrap">${a.nome || ''}</td>
          <td class="px-6 py-4 whitespace-nowrap">${a.funcao || ''}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <button onclick="editarArtista(${a.id}, '${nomeSafe}', '${funcaoSafe}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Editar</button>
            <button onclick="deletarArtista(${a.id})" class="text-red-600 hover:text-red-900">Deletar</button>
          </td>
        `;
        tabelaBody.appendChild(row);
      });
    }

    infoPaginacao.textContent = `Página ${data.pagina_atual} de ${data.total_paginas} (Total: ${data.total_registros} registros)`;
    btnAnterior.disabled = data.pagina_atual <= 1;
    btnProximo.disabled = data.pagina_atual >= data.total_paginas;
    // Corrige “pular” além do total
    if (paginaAtual > data.total_paginas) {
      paginaAtual = data.total_paginas || 1;
    }
  } catch (err) {
    console.error(err);
    tabelaBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Erro ao carregar os dados.</td></tr>';
  } finally {
    buscando = false;
  }
}

async function salvarArtista(e) {
  e.preventDefault();
  const id = document.getElementById('artista-id').value;
  const nome = document.getElementById('nome-artista').value.trim();
  const funcao = document.getElementById('funcao-artista').value.trim();
  if (!nome) { alert('Informe o nome.'); return; }

  const method = id ? 'PUT' : 'POST';
  const url = id ? `/api/artistas/${id}` : '/api/artistas';

  try {
    const resp = await fetch(url, {
      method,
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ nome, funcao })
    });
    if (!resp.ok) throw new Error('Falha ao salvar');
    resetarFormulario();
    carregarArtistas();
  } catch (err) {
    console.error(err); alert('Erro ao salvar o artista.');
  }
}

function editarArtista(id, nome, funcao) {
  document.getElementById('artista-id').value = id;
  document.getElementById('nome-artista').value = nome;
  document.getElementById('funcao-artista').value = funcao;
  document.getElementById('btn-cancelar').classList.remove('hidden');
}

function resetarFormulario() {
  document.getElementById('form-artista').reset();
  document.getElementById('artista-id').value = '';
  document.getElementById('btn-cancelar').classList.add('hidden');
}

async function deletarArtista(id) {
  if (!confirm('Tem certeza que deseja deletar este artista?')) return;
  try {
    const resp = await fetch(`/api/artistas/${id}`, { method: 'DELETE' });
    if (!resp.ok) throw new Error('Falha na exclusão');
    carregarArtistas();
  } catch (err) {
    console.error(err); alert('Erro ao deletar artista.');
  }
}
</script>
{% endblock %}